<div class="card">
    <div class="card-body">
        <ngx-datatable [rows]="stages.items" [count]="stages.totalCount" [list]="list" [columnMode]="'force'" default>
            <ngx-datatable-column [sortable]="false" [canAutoResize]="false" [width]="50">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    <app-production-actions [stage]="row" [showBayDetails]="true" [showAssignBay]="true"
                        (change)="list?.get()"
                        [(isIssueModalVisible)]="issueModalVisible[row.carId]"></app-production-actions>
                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column [name]="'::Vin' | abpLocalization" prop="vin" [canAutoResize]="false" [width]="150">
                <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
                    <div class="align-items-center d-flex">
                        <a type="button" class="text-primary clickable" (click)="openCheckInModal(row)">
                            <strong>{{ value | slice:-6 }}</strong>
                        </a>
                        <small>
                            <a class="ms-1" [href]="'https://tracking.ausev.com.au/stock?q=' + row.vin" target="_blank">
                                <i class="fas fa-external-link"></i>
                            </a>
                        </small>
                    </div>

                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column [name]="'::Owner' | abpLocalization" prop="ownerName" [canAutoResize]="false"
                [width]="200">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    {{ row.ownerName | uppercase }}
                </ng-template>
            </ngx-datatable-column>

            <ngx-datatable-column [name]="'::Model' | abpLocalization" prop="modelName">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    <div abpEllipsis>{{ row.modelName }}</div>
                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column [name]="'::Color' | abpLocalization" prop="color" [canAutoResize]="false"
                [width]="200">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    {{ row.color | uppercase }}
                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column [name]="'::StorageLocation' | abpLocalization" prop="storageLocation"
                [sortable]="false">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    {{ row?.storageLocation ? ('::Enum:StorageLocation.' + row.storageLocation | abpLocalization) : '-'
                    }}
                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column *abpPermission="'WorkShopManagement.Cars.Edit'" [name]="'::AVV' | abpLocalization" prop="avvStatus" [canAutoResize]="false"
                [width]="140" [sortable]="false">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    <div class="text-center badge bg-{{mapAvvStatus(row)}} link" (click)="openAvvModal(row)">
                        {{ row?.avvStatus ? (("::Enum:AvvStatus." + row.avvStatus) | abpLocalization) : 'AVV' }}
                    </div>
                </ng-template>
            </ngx-datatable-column>


            <ngx-datatable-column [name]="'::Recalls' | abpLocalization" [canAutoResize]="false" [width]="70"
                [sortable]="false">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    <div class="text-center text-{{getRecallColor(row)}}">
                        <i class="fas fa-bullhorn link" (click)="openRecallModal(row)"></i>
                    </div>
                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column *abpPermission="'WorkShopManagement.Cars.Edit'" [name]="'::Est. Release' | abpLocalization" prop="estimatedRelease" [sortable]="false"
                [canAutoResize]="false" [width]="100">
                <ng-template let-row="row" ngx-datatable-cell-template>

                    <div class="text-center text-{{getEstRelease(row)}}">
                        <i class="fas fa-calendar-alt link" (click)="openEstReleaseModal(row)"></i>
                    </div>
                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column *abpPermission="'WorkShopManagement.Issues'" [name]="'::Issues' | abpLocalization" prop="issueStatus" [sortable]="false"
                [canAutoResize]="false" [width]="70">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    <div class="text-center text-{{mapIssueStatusColor(row)}}">
                        <i class="fas fa-triangle-exclamation link" (click)="openIssueModal(row)"></i>
                    </div>
                </ng-template>
            </ngx-datatable-column>
            <ngx-datatable-column *abpPermission="'WorkShopManagement.QualityGates.Edit'" [name]="'::QualityGates' | abpLocalization" [sortable]="false" [canAutoResize]="false"
                [width]="100">
                <ng-template let-row="row" ngx-datatable-cell-template>
                    <!-- show active icon only if carBayId exists -->
                    <ng-container *ngIf="row?.carBayId; else noBay">
                        <div class="text-center text-primary">
                            <i class="fas fa-clipboard-check link" title="Quality Gates"
                                (click)="openQualityGates(row)"></i>
                        </div>
                    </ng-container>

                    <!-- disabled state -->
                    <ng-template #noBay>
                        <div class="text-center text-secondary">
                            <i class="fas fa-clipboard-check opacity-25" title="No Bay"></i>
                        </div>
                    </ng-template>
                </ng-template>
            </ngx-datatable-column>

        </ngx-datatable>

    </div>
</div>


<!-- MODALS -->

<app-avv-status-modal [(visible)]="isAvvModalVisible" [carId]="selected?.carId" [vin]="selected?.vin" [currentStatus]="selected?.avvStatus"
    (statusUpdated)="list.get()"></app-avv-status-modal>
<app-est-release-modal #estReleaseModal (saved)="list.get()"></app-est-release-modal>
<app-recalls [(visible)]="isRecallModalVisible" [carId]="selected?.carId" [vin]="selected?.vin" (submit)="list?.get()" />
<app-check-in-report-modal [(visible)]="isCheckInModalVisible" [carId]="selected.carId" [carVin]="selected.vin"
    (submit)="list?.get()"></app-check-in-report-modal>
<app-quality-gates-modal [carId]="selected?.carId" [vin]="selected?.vin" [(visible)]="isQualityGatesModalVisible" (saved)="list?.get()">
</app-quality-gates-modal>