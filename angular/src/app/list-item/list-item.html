<!-- list-item.html -->
<abp-page *abpPermission="'WorkShopManagement.ListItems'">
    <app-topbar-layout titleKey="Menu:ListItems" [(filters)]="filters" [list]="list" showBackButton (onBack)="goBack()">
        <div topbarActions>
            <ng-container *abpPermission="'WorkShopManagement.ListItems.Create'">
                <button class="btn btn-sm btn-outline-primary" (click)="createListItem()">
                    <i class="fas fa-plus"></i>
                    {{ '::AddNew' | abpLocalization }}
                </button>
            </ng-container>
        </div>
        <div class="card">
            <div class="card-body">
                <ngx-datatable [rows]="listItems.items" [count]="listItems.totalCount" [columnMode]="'force'"
                    [list]="list" default>
                    <ngx-datatable-column [sortable]="false" [canAutoResize]="false" [width]="50">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <div ngbDropdown container="body" class="d-inline-block">
                                <button class="ngx-actions-btn" data-toggle="dropdown" aria-haspopup="true"
                                    ngbDropdownToggle>
                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                </button>
                                <div ngbDropdownMenu>
                                    <button *abpPermission="'WorkShopManagement.ListItems.Edit'" ngbDropdownItem
                                        (click)="edit(row.id)">
                                        {{ '::Edit' | abpLocalization }}
                                    </button>
                                    <button *abpPermission="'WorkShopManagement.ListItems.Delete'" ngbDropdownItem
                                        (click)="delete(row.id)">
                                        {{ '::Delete' | abpLocalization }}
                                    </button>
                                </div>
                            </div>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column [name]="'::Position' | abpLocalization" prop="position"
                        [canAutoResize]="false" [width]="100" [maxWidth]="120"></ngx-datatable-column>
                    <ngx-datatable-column [name]="'::Name' | abpLocalization" prop="name"></ngx-datatable-column>

                    <ngx-datatable-column [name]="'::CommentType' | abpLocalization" [canAutoResize]="false"
                        [width]="150">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <ng-container *ngIf="row?.commentType != null; else noValue">
                                {{ ('::Enum:CommentType.' + row.commentType) | abpLocalization }}
                            </ng-container>
                            <ng-template #noValue>-</ng-template>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column [name]="'::CommentPlaceholder' | abpLocalization" prop="commentPlaceholder">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            {{ row?.commentPlaceholder ? row.commentPlaceholder : '-' }}
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column [name]="'::IsSeparator' | abpLocalization" [canAutoResize]="false"
                        [width]="120">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <div class="text-center">
                                <span [class.text-success]="row.isSeparator" [class.text-danger]="!row.isSeparator">
                                    <i class="fas" [class.fa-check]="row.isSeparator"
                                        [class.fa-times]="!row.isSeparator"></i>
                                </span>
                            </div>
                        </ng-template>
                    </ngx-datatable-column>

                    <!-- <ngx-datatable-column [name]="'::IsAttachmentRequired' | abpLocalization" [maxWidth]="200">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            {{ row.isAttachmentRequired ? ('::Yes' | abpLocalization) : ('::No' | abpLocalization) }}
                        </ng-template>
                    </ngx-datatable-column> -->

                    <ngx-datatable-column [name]="'::Images' | abpLocalization" [sortable]="false">
                        <ng-template let-row="row" ngx-datatable-cell-template>
                            <div class="d-flex gap-2 flex-wrap" *ngIf="row?.entityAttachments?.length">
                                <ng-container *ngFor="let ea of row.entityAttachments">
                                    <img *ngIf="ea?.attachment?.path" nz-image width="60" height="60"
                                        [nzSrc]="ea.attachment.path" [alt]="ea?.attachment?.name || 'attachment'"
                                        style="object-fit: cover; border-radius: 6px;" />
                                </ng-container>
                            </div>

                            <span class="text-muted" *ngIf="!row?.entityAttachments?.length">-</span>
                        </ng-template>
                    </ngx-datatable-column>
                </ngx-datatable>
            </div>
        </div>
    </app-topbar-layout>
</abp-page>


<abp-modal [(visible)]="isModalOpen">
    <ng-template #abpHeader>
        <h3>{{ (selected?.id ? '::EditListItem' : '::NewListItem') | abpLocalization }}</h3>
    </ng-template>

    <ng-template #abpBody>
        <form [formGroup]="form" (submit)="save()">
            <div class="row g-3">
                <div class="col-12 col-md-8">
                    <label class="form-label">
                        {{ '::Name' | abpLocalization }} <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" formControlName="name" />
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">
                        {{ '::Position' | abpLocalization }} <span class="text-danger">*</span>
                    </label>
                    <input type="number" class="form-control" formControlName="position" min="0" />
                </div>

                <div class="col-12 col-md-6">
                    <label class="form-label">
                        {{ '::CommentType' | abpLocalization }} <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" formControlName="commentType">
                        <option *ngFor="let o of commentTypes" [ngValue]="o.value">
                            {{ ('::Enum:CommentType.' + o.value) | abpLocalization }}
                        </option>
                    </select>
                </div>

                <div class="col-12 col-md-6">
                    <label class="form-label">{{ '::CommentPlaceholder' | abpLocalization }}</label>
                    <input type="text" class="form-control" formControlName="commentPlaceholder" />
                    <small class="text-muted">{{ '::DefaultSameAsName' | abpLocalization }}</small>
                </div>

                <div class="col-12 col-md-6">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" formControlName="isSeparator"
                            id="isSeparator" />
                        <label class="form-check-label" for="isSeparator">
                            {{ '::IsSeparator' | abpLocalization }}
                        </label>
                    </div>
                </div>

                <!-- <div class="col-12 col-md-6">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" formControlName="isAttachmentRequired"
                            id="isAttachmentRequired" />
                        <label class="form-check-label" for="isAttachmentRequired">
                            {{ '::IsAttachmentRequired' | abpLocalization }}
                        </label>
                    </div>
                </div> -->

                <!-- Attachments -->
                <div class="col-12">
                    <label class="form-label">{{ '::Attachments' | abpLocalization }}</label>
                    <app-file-upload [multiple]="true" [(tempFiles)]="tempFiles" [(existingFiles)]="existingFiles">
                    </app-file-upload>
                </div>

            </div>

            <!-- Radio Options only when list-item exists -->
            <div class="row g-2" *ngIf="selected?.id">
                <div class="col-12">
                    <hr class="my-3" />
                </div>
                <div class="col-12">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="m-0">{{ '::RadioOptions' | abpLocalization }}</h6>
                    </div>
                </div>

                <div class="col-12">
                    <input type="text" [(ngModel)]="tagInputValue" class="form-control"
                        [ngModelOptions]="{ standalone: true }" [disabled]="isRadioBusy" (blur)="confirmTagInput()"
                        (keydown.enter)="$event.stopPropagation(); confirmTagInput()" />
                    @if (pendingRadioNames?.length || radioOptions?.length) {
                    <table class="table table-bordered mt-2">
                        <thead>
                            <tr>
                                <th>{{ '::Radio Name' | abpLocalization }}</th>
                                <th width="20%">{{ '::Acceptable' | abpLocalization }}</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let n of pendingRadioOptions">
                                <td>{{ n.name }} <span class="ms-1 badge bg-warning text-dark">Pending</span></td>
                                <td class="text-center">
                                    <div class="form-check-inline">
                                        <input type="checkbox" name="" id="" class="form-check-input"
                                            [(ngModel)]="n.isAcceptable" [ngModelOptions]="{ standalone: true }"
                                            [disabled]="isRadioBusy">
                                    </div>
                                </td>
                                <td>
                                    <i class="fas fa-trash text-danger pointer" (click)="removePendingTag(n.name)"></i>
                                </td>
                            </tr>
                            <tr *ngFor="let n of radioOptions">
                                <td>{{ n.name }}</td>
                                <td class="text-center">
                                    <div class="form-check-inline">
                                        <input type="checkbox" name="" id="" class="form-check-input"
                                            [(ngModel)]="n.isAcceptable" [ngModelOptions]="{ standalone: true }"
                                            [disabled]="isRadioBusy">
                                    </div>
                                </td>
                                <td>
                                    <i class="fas fa-trash text-danger pointer" (click)="removeDbTag(n)"></i>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    }

                    <small class="text-muted d-block mt-2" *ngIf="pendingRadioOptions?.length">
                        Pending options will be saved only when you click Save/Update.
                    </small>
                </div>
            </div>

        </form>
    </ng-template>

    <ng-template #abpFooter>
        <button type="button" class="btn btn-outline-primary" (click)="closeModal()">
            {{ '::Close' | abpLocalization }}
        </button>

        <button type="submit" class="btn btn-primary" (click)="save()" [disabled]="form?.invalid || !checkListId">
            <i class="fas fa-save me-1"></i>
            {{ (selected?.id ? '::Update' : '::Save') | abpLocalization }}
        </button>
    </ng-template>
</abp-modal>