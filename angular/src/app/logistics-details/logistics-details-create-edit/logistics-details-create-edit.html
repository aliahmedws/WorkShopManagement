<abp-modal [(visible)]="visible" (visibleChange)="visibleChange.emit($event)" (appear)="open()"
    [options]="modalOptions">
    <ng-template #abpHeader>
        <div class="d-flex align-items-center justify-content-between w-100">
            <div class="d-flex flex-column">
                <div class="modal-title-line">
                    <span class="h2">{{ vin ?? '-' }}</span>
                    <span class="ms-2">{{ '::Logistics' | abpLocalization }}</span>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #abpBody>
        @if (loading) {
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        }

        @if (!loading && form) {
        <ng-template #iconCre><i class="fas fa-file-contract"></i></ng-template>
        <ng-template #iconPort><i class="fas fa-ship"></i></ng-template>
        <ng-template #iconClearance><i class="fas fa-stamp"></i></ng-template>
        <ng-template #iconScd><i class="fas fa-warehouse"></i></ng-template>

        <ng-template #descCre>
            <div class="d-flex flex-column small-date">
                @if (form.get('creSubmissionDate')?.value) {
                <small>{{ form.get('creSubmissionDate')?.value | date:'mediumDate' }}</small>
                } @else {
                <ng-container *ngTemplateOutlet="pending"></ng-container>
                }
            </div>
        </ng-template>

        <ng-template #descPort>
            <div class="d-flex flex-column small-date">
                @if (latestEstimate?.etaPort) {
                <small class="text-muted">Est: {{ latestEstimate?.etaPort | date:'dd/MM/yy' }}</small>
                }
                @if (form.get('actualPortArrivalDate')?.value) {
                <small class="fw-bold text-primary">Act: {{ form.get('actualPortArrivalDate')?.value | date:'dd/MM/yy'
                    }}</small>
                }
            </div>
        </ng-template>

        <ng-template #descClearance>
            <div class="d-flex flex-column small-date">
                @if (form.get('clearanceDate')?.value) {
                <small>{{ form.get('clearanceDate')?.value | date:'mediumDate' }}</small>
                } @else {
                <ng-container *ngTemplateOutlet="pending"></ng-container>
                }
            </div>
        </ng-template>

        <ng-template #descScd>
            <div class="d-flex flex-column small-date">
                @if (latestEstimate?.etaScd) {
                <small class="text-muted">Est: {{ latestEstimate?.etaScd | date:'dd/MM/yy' }}</small>
                }
                @if (form.get('actualScdArrivalDate')?.value) {
                <small class="fw-bold text-primary">Act: {{ form.get('actualScdArrivalDate')?.value | date:'dd/MM/yy'
                    }}</small>
                }
            </div>
        </ng-template>

        <ng-template #pending>
            <small class="text-muted fst-italic">{{ '::Pending' | abpLocalization }}</small>
        </ng-template>

        <form [formGroup]="form" (ngSubmit)="save()">

            @if (isEditMode) {
            <div class="px-2 pb-2 mt-4">
                <nz-steps [nzCurrent]="currentStep" nzSize="small" nzLabelPlacement="vertical">
                    <nz-step [nzTitle]="'::CreDetails' | abpLocalization" [nzIcon]="iconCre"
                        [nzDescription]="descCre"></nz-step>
                    <nz-step [nzTitle]="'::PortArrival' | abpLocalization" [nzIcon]="iconPort"
                        [nzDescription]="descPort"></nz-step>
                    <nz-step [nzTitle]="'::Clearance' | abpLocalization" [nzIcon]="iconClearance"
                        [nzDescription]="descClearance"></nz-step>
                    <nz-step [nzTitle]="'::ScdArrival' | abpLocalization" [nzIcon]="iconScd"
                        [nzDescription]="descScd"></nz-step>
                </nz-steps>
            </div>
            <hr class="my-4">
            }

            <div class="row g-2">
                <div class="col-12 col-lg-3">
                    <h5>{{ '::BasicInformation' | abpLocalization }}</h5>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="row g-2">
                        <div class="col-12 col-md-6 form-group">
                            <label class="form-label required">{{ '::Port' | abpLocalization }}</label>
                            <nz-select formControlName="port" nzSize="large" class="w-100">
                                @for (option of portOptions; track option.value) {
                                <nz-option [nzLabel]="('::Enum:Port.' + option.value) | abpLocalization"
                                    [nzValue]="option.value"></nz-option>
                                }
                            </nz-select>
                        </div>
                        <div class="col-12 col-md-6 form-group">
                            <label class="form-label">{{ '::BookingNumber' | abpLocalization }}</label>
                            <input class="form-control" formControlName="bookingNumber" />
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr>
                </div>
            </div>

            @if (isEditMode) {
            <div class="row g-2">
                <div class="col-12 col-lg-3">
                    <h5>{{ '::CreDetails' | abpLocalization }}</h5>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="row g-2">
                        <div class="col-12 col-md-4 form-group">
                            <label class="form-label required">{{ '::CreStatus' | abpLocalization }}</label>
                            <nz-select formControlName="creStatus" nzSize="large" class="w-100">
                                @for (option of creStatusOptions; track option.value) {
                                <nz-option [nzLabel]="('::Enum:CreStatus.' + option.value) | abpLocalization"
                                    [nzValue]="option.value"></nz-option>
                                }
                            </nz-select>
                        </div>
                        <div class="col-12 col-md-4 form-group">
                            <label class="form-label">{{ '::RvsaNumber' | abpLocalization }}</label>
                            <input class="form-control" formControlName="rvsaNumber" />
                        </div>
                        <div class="col-12 col-md-4 form-group">
                            <label class="form-label">{{ '::CreSubmissionDate' | abpLocalization }}</label>
                            <input #crePicker="ngbDatepicker" class="form-control" formControlName="creSubmissionDate"
                                ngbDatepicker (click)="crePicker.toggle()" />
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-12 col-lg-3">
                    <h5>{{ '::ArrivalEstimates' | abpLocalization }}</h5>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            @if (!latestEstimate) {
                            <div class="alert alert-info m-0">
                                <i class="fas fa-circle-info me-2"></i>
                                <small>{{ '::NoEstimateAvailable' | abpLocalization }}</small>
                            </div>
                            }

                            @if (latestEstimate) {
                            <div class="card border shadow-sm">
                                <div class="card-body p-2">
                                    <div class="row align-items-center m-1 g-0">
                                        <div class="col-auto border-end pe-3 ps-2">
                                            <small class="text-uppercase text-muted fw-bold d-block"
                                                style="font-size: 0.65rem;">{{ '::LatestEtaPort' | abpLocalization
                                                }}</small>
                                            <span class="fw-bold text-primary fs-6">{{ latestEstimate.etaPort |
                                                date:'mediumDate' }}</span>
                                        </div>
                                        <div class="col-auto ps-3">
                                            <small class="text-uppercase text-muted fw-bold d-block"
                                                style="font-size: 0.65rem;">{{ '::LatestEtaScd' | abpLocalization
                                                }}</small>
                                            <span class="fw-bold text-primary fs-6">{{ latestEstimate.etaScd |
                                                date:'mediumDate' }}</span>
                                        </div>
                                        <div class="col text-end text-truncate text-muted fst-italic ms-auto pe-2"
                                            style="max-width: 250px; font-size: 0.85rem;">
                                            {{ latestEstimate.notes }}
                                        </div>
                                        @if (latestEstimate) {
                                        <div class="col text-end">
                                            <button type="button" class="btn btn-sm btn-outline-info"
                                                (click)="viewEstimateHistory()">
                                                <i class="fa fa-list-ul me-1"></i> {{ '::ViewHistory' | abpLocalization
                                                }}
                                            </button>
                                        </div>

                                        }
                                    </div>
                                </div>
                            </div>
                            }
                        </div>

                        <div class="flex-shrink-0">
                            @if (!latestEstimate) {
                            <button type="button" class="btn btn-sm btn-primary ms-1" (click)="addFirstEstimate()">
                                <i class="fas fa-plus me-1"></i> {{ '::AddEta' | abpLocalization }}
                            </button>
                            }
                            <!-- @if (latestEstimate) {
                            <button type="button" class="btn btn-sm btn-outline-info" (click)="viewEstimateHistory()">
                                <i class="fa fa-history me-1"></i> {{ '::ViewHistory' | abpLocalization }}
                            </button>
                            } -->
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-12 col-lg-3">
                    <h5>{{ '::ClearanceDetails' | abpLocalization }}</h5>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="row g-2">
                        <div class="col-12 col-md-6 form-group">
                            <label class="form-label">{{ '::ClearingAgent' | abpLocalization }}</label>
                            <input class="form-control" formControlName="clearingAgent" />
                        </div>
                        <div class="col-12 col-md-6 form-group">
                            <label class="form-label">{{ '::ClearanceDate' | abpLocalization }}</label>
                            <input #clearPicker="ngbDatepicker" class="form-control" formControlName="clearanceDate"
                                ngbDatepicker (click)="clearPicker.toggle()" />
                        </div>
                        <div class="col-12 form-group">
                            <label class="form-label">{{ '::ClearanceRemarks' | abpLocalization }}</label>
                            <textarea class="form-control" formControlName="clearanceRemarks" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-12 col-lg-3">
                    <h5>{{ '::ArrivalInformation' | abpLocalization }}</h5>
                </div>
                <div class="col-12 col-lg-9">
                    @if (form.errors?.['portAfterScd'] && (form.touched || form.dirty)) {
                    <div class="alert alert-danger mb-2">
                        <small><i class="fas fa-exclamation-circle me-1"></i> {{ '::Logistics:InvalidActualArrivalRange'
                            | abpLocalization }}</small>
                    </div>
                    }
                    <div class="row g-2">
                        <div class="col-12 col-md-6 form-group">
                            <label class="form-label">{{ '::ActualPortArrivalDate' | abpLocalization }}</label>
                            <input #portArrPicker="ngbDatepicker" class="form-control"
                                formControlName="actualPortArrivalDate" ngbDatepicker
                                (click)="portArrPicker.toggle()" />
                        </div>
                        <div class="col-12 col-md-6 form-group">
                            <label class="form-label">{{ '::ActualScdArrivalDate' | abpLocalization }}</label>
                            <input #scdArrPicker="ngbDatepicker" class="form-control"
                                formControlName="actualScdArrivalDate" ngbDatepicker (click)="scdArrPicker.toggle()" />
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr>
                </div>
            </div>
            }

            <div class="row g-2">
                <div class="col-12 col-lg-3">
                    <h5>{{ '::Attachments' | abpLocalization }}</h5>
                    <small class="text-muted d-block">{{ '::LogisticsAttachments.Help' | abpLocalization }}</small>
                </div>
                <div class="col-12 col-lg-9">
                    <app-file-upload [multiple]="true" [(tempFiles)]="tempFiles" [(existingFiles)]="existingFiles">
                    </app-file-upload>
                </div>
            </div>
        </form>
        }
    </ng-template>

    <ng-template #abpFooter>
        <button type="button" class="btn btn-outline-primary me-2 px-3" (click)="close()">
            {{ '::Close' | abpLocalization }}
        </button>
        <button *abpPermission="'WorkShopManagement.LogisticsDetails.Create'" type="button" class="btn btn-primary px-3" [disabled]="form.invalid || loading" (click)="save()">
            <i class="fas fa-save me-1"></i> 
            {{ (isEditMode ? '::Update' : '::Create') | abpLocalization }}
        </button>
    </ng-template>
</abp-modal>




<app-arrival-estimates-create-edit-modal [(visible)]="isEstimateModalVisible" [logisticsDetailId]="selectedId!"
    (submit)="fetchLatestEstimate(selectedId!)">
</app-arrival-estimates-create-edit-modal>

<app-arrival-estimates [(visible)]="isEstimateListVisible" [logisticsDetailId]="selectedId!"></app-arrival-estimates>